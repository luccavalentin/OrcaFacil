<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OrçaFácil - Gestão de Orçamentos</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
      /* Estilos gerais da aplicação */
      body {
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .glow-effect:hover,
      .glow-effect:focus-within {
        box-shadow: 0 0 15px 5px var(--tw-shadow-color);
        transition: box-shadow 0.3s ease;
      }
      /* Scrollbar customizada */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #0f172a;
      } /* slate-900 */
      ::-webkit-scrollbar-thumb {
        background: #4f46e5;
        border-radius: 10px;
      } /* indigo-600 */
      ::-webkit-scrollbar-thumb:hover {
        background: #4338ca;
      } /* indigo-700 */

      /* Remove setas de inputs numéricos */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      /* Animações */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes scaleUp {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }
      .animate-scale-up {
        animation: scaleUp 0.3s ease-out forwards;
      }

      /* Estilos para impressão */
      @media print {
        body {
          background-color: #ffffff !important;
          color: #000000 !important;
        }
        #sidebar,
        #hamburger-btn,
        .print-hide {
          display: none !important;
        }
        #app-container {
          display: block !important;
        }
        main {
          padding: 0 !important;
        }
        .view-content {
          display: block !important;
          animation: none !important;
        }
        .bg-slate-800,
        .bg-slate-900,
        .bg-slate-700 {
          background-color: #ffffff !important;
          box-shadow: none !important;
          border: 1px solid #e2e8f0;
        }
        .text-white,
        .text-slate-300,
        .text-slate-400,
        .text-indigo-400 {
          color: #1e293b !important;
        }
        h2,
        h3,
        p,
        th,
        td,
        span,
        div {
          color: #1e293b !important;
        }
      }
    </style>
  </head>
  <body class="bg-slate-900 text-slate-300">
    <div id="app-container" class="flex h-screen w-full">
      <aside
        id="sidebar"
        class="w-64 -translate-x-full absolute lg:relative lg:translate-x-0 z-40 h-full bg-slate-800 border-r border-slate-700/50 transition-transform duration-300 ease-in-out print-hide"
      >
        <!-- O conteúdo da Sidebar será gerado por JavaScript -->
      </aside>

      <div
        id="sidebar-overlay"
        class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden print-hide"
      ></div>

      <div class="flex-1 flex flex-col h-screen overflow-y-auto">
        <header
          class="lg:hidden h-16 flex items-center justify-between px-4 bg-slate-800 border-b border-slate-700 sticky top-0 z-20 print-hide"
        >
          <button id="hamburger-btn" class="text-slate-400">
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
          <h1 class="text-xl font-bold text-white">
            Orça<span class="text-indigo-400">Fácil</span>
          </h1>
          <div></div>
        </header>

        <main class="flex-1 p-4 sm:p-6 lg:p-8">
          <section
            id="dashboard-view"
            class="view-content hidden animate-fade-in"
          ></section>
          <section
            id="new-quote-view"
            class="view-content hidden animate-fade-in"
          ></section>
          <section
            id="quotes-history-view"
            class="view-content hidden animate-fade-in"
          ></section>
          <section
            id="clients-view"
            class="view-content hidden animate-fade-in"
          ></section>
          <section
            id="products-view"
            class="view-content hidden animate-fade-in"
          ></section>
          <section
            id="tasks-view"
            class="view-content hidden animate-fade-in"
          ></section>
          <section
            id="profile-view"
            class="view-content hidden animate-fade-in"
          ></section>
          <section
            id="reports-view"
            class="view-content hidden animate-fade-in"
          ></section>
        </main>
      </div>
    </div>

    <div id="modal-container"></div>
    <div
      id="toast-container"
      class="fixed top-5 right-5 z-50 flex flex-col gap-3"
    ></div>

    <script type="module">
      // Módulos de Geração de PDF
      const { jsPDF } = window.jspdf;

      // =================================================================================
      // ESTADO GLOBAL DA APLICAÇÃO
      // =================================================================================
      let state = {
        provider: {
          name: "Nome da Sua Empresa",
          docType: "cnpj",
          docNumber: "",
          address: "",
          phone: "",
          email: "",
          logoUrl: "https://placehold.co/150x50/e2e8f0/94a3b8?text=Sua+Logo",
          cep: "",
          street: "",
          number: "",
          neighborhood: "",
          city: "",
          state: "",
        },
        clients: [],
        products: [],
        quotes: [],
        tasks: [],
        currentQuote: null, // Usado para criar/editar um orçamento
        nextQuoteNumber: 1,
        activeToasts: new Set(),
      };

      // =================================================================================
      // FUNÇÕES DE UTILIDADE E PERSISTÊNCIA
      // =================================================================================

      const generateUniqueId = () =>
        `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

      const saveState = () => {
        try {
          localStorage.setItem("orcaFacilState", JSON.stringify(state));
        } catch (e) {
          console.error("Erro ao salvar o estado:", e);
          showToast(
            "Erro ao salvar dados. O armazenamento pode estar cheio.",
            "error"
          );
        }
      };

      const loadState = () => {
        try {
          const savedStateJSON = localStorage.getItem("orcaFacilState");
          if (savedStateJSON) {
            const loadedState = JSON.parse(savedStateJSON);

            // Merge deeply for provider to preserve new fields if they exist in state but not in loadedState
            state = {
              ...state,
              ...loadedState,
              provider: { ...state.provider, ...loadedState.provider },
            };

            // Ensure notes exist for older clients
            state.clients = (loadedState.clients || []).map((client) => ({
              ...client,
              notes: client.notes || "",
            }));
          } else {
            initializeDefaultData();
          }
        } catch (e) {
          console.error(
            "Erro ao carregar o estado, redefinindo para o padrão:",
            e
          );
          initializeDefaultData();
        }
      };

      const initializeDefaultData = () => {
        state = {
          provider: {
            name: "Nome da Sua Empresa",
            docType: "cnpj",
            docNumber: "",
            address: "",
            phone: "",
            email: "",
            logoUrl: "https://placehold.co/150x50/e2e8f0/94a3b8?text=Sua+Logo",
            cep: "",
            street: "",
            number: "",
            neighborhood: "",
            city: "",
            state: "",
          },
          clients: [],
          products: [],
          tasks: [],
          quotes: [],
          nextQuoteNumber: 1,
          activeToasts: new Set(),
          currentQuote: null,
        };
        saveState();
      };

      const formatCurrency = (value) =>
        new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
        }).format(value || 0);

      const formatDate = (dateString) => {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString("pt-BR", { timeZone: "UTC" });
      };

      // =================================================================================
      // CONTROLE DE TEMA (MODO CLARO/ESCURO)
      // =================================================================================
      const setTheme = (theme) => {
        const body = document.body;
        const darkIcon = document.getElementById("theme-toggle-dark-icon");
        const lightIcon = document.getElementById("theme-toggle-light-icon");
        const toggleText = document.getElementById("theme-toggle-text");

        // Seleciona todos os elementos de texto que precisam mudar de cor
        const textElements = document.querySelectorAll(".theme-sensitive-text");

        if (theme === "light") {
          // Define o fundo do body e a cor do texto padrão para o modo claro
          body.classList.remove("bg-slate-900");
          body.classList.add("bg-slate-100");

          // Altera os ícones e o texto do botão
          if (darkIcon) darkIcon.classList.add("hidden");
          if (lightIcon) lightIcon.classList.remove("hidden");
          if (toggleText) toggleText.textContent = "Modo Escuro";

          // Altera a cor do texto principal
          textElements.forEach((el) => {
            el.classList.remove("text-white");
            el.classList.add("text-slate-900");
          });
        } else {
          // 'dark' theme
          // Define o fundo do body e a cor do texto padrão para o modo escuro
          body.classList.remove("bg-slate-100");
          body.classList.add("bg-slate-900");

          // Altera os ícones e o texto do botão
          if (darkIcon) darkIcon.classList.remove("hidden");
          if (lightIcon) lightIcon.classList.add("hidden");
          if (toggleText) toggleText.textContent = "Modo Claro";

          // Altera a cor do texto principal
          textElements.forEach((el) => {
            el.classList.remove("text-slate-900");
            el.classList.add("text-white");
          });
        }
        localStorage.setItem("theme", theme);
      };

      const initTheme = () => {
        const themeToggleBtn = document.getElementById("theme-toggle");
        if (!themeToggleBtn) return;

        // Tenta obter o tema do sistema do usuário se não houver um salvo
        const preferDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        const savedTheme =
          localStorage.getItem("theme") || (preferDark ? "dark" : "light");

        // Aplica o tema na carga inicial
        setTheme(savedTheme);

        themeToggleBtn.addEventListener("click", () => {
          const currentTheme = localStorage.getItem("theme") || "dark";
          const newTheme = currentTheme === "dark" ? "light" : "dark";
          setTheme(newTheme);
        });
      };

      // =================================================================================
      // CONTROLE DA INTERFACE (VIEWS, MODAIS, TOASTS)
      // =================================================================================

      const switchView = (viewId, quoteIdToEdit = null) => {
        document
          .querySelectorAll(".view-content")
          .forEach((view) => view.classList.add("hidden"));
        const targetView = document.getElementById(viewId);
        if (targetView) {
          targetView.innerHTML = ""; // Limpa a view antes de renderizar
          targetView.classList.remove("hidden");

          const renderFunctions = {
            "dashboard-view": renderDashboard,
            "new-quote-view": () => renderNewQuote(quoteIdToEdit),
            "quotes-history-view": renderHistoryList,
            "clients-view": renderClientsList,
            "products-view": renderProductsList,
            "tasks-view": renderTasksList,
            "profile-view": renderProfileView,
            "reports-view": renderReportsView,
          };

          if (renderFunctions[viewId]) {
            renderFunctions[viewId]();
          }

          // Reaplica o tema atual ao novo conteúdo para garantir a consistência
          const currentTheme = localStorage.getItem("theme") || "dark";
          setTheme(currentTheme);
        }
        document.querySelectorAll("#sidebar .nav-link").forEach((link) => {
          link.classList.remove("bg-indigo-600", "text-white");
          if (link.getAttribute("href") === `#${viewId}`) {
            link.classList.add("bg-indigo-600", "text-white");
          }
        });
        toggleSidebar(false);
      };

      const toggleSidebar = (forceShow = null) => {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        const show =
          forceShow !== null
            ? forceShow
            : !sidebar.classList.contains("translate-x-0");

        sidebar.classList.toggle("-translate-x-full", !show);
        sidebar.classList.toggle("translate-x-0", show);
        overlay.classList.toggle("hidden", !show);
      };

      const showToast = (message, type = "success") => {
        const toastKey = `${message}-${type}`;
        if (state.activeToasts.has(toastKey)) return;
        state.activeToasts.add(toastKey);

        const toastContainer = document.getElementById("toast-container");
        const toastId = generateUniqueId();
        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
        };

        const toast = document.createElement("div");
        toast.id = toastId;
        toast.className = `animate-fade-in flex items-center gap-4 text-white p-4 rounded-lg shadow-lg ${
          colors[type] || colors.info
        }`;
        toast.innerHTML = `
            <div class="flex-1">${message}</div>
            <button data-toast-close="${toastId}" class="p-1 rounded-full hover:bg-white/20 transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
        `;

        const removeToast = () => {
          state.activeToasts.delete(toastKey);
          const el = document.getElementById(toastId);
          if (el) {
            el.classList.add("animate-fade-out");
            setTimeout(() => el.remove(), 300);
          }
        };

        const timeoutId = setTimeout(removeToast, 5000);
        toast
          .querySelector(`[data-toast-close="${toastId}"]`)
          .addEventListener("click", () => {
            clearTimeout(timeoutId);
            removeToast();
          });

        toastContainer.appendChild(toast);
      };

      const showConfirmModal = (message, onConfirm) => {
        const modalContainer = document.getElementById("modal-container");
        const modalId = generateUniqueId();
        modalContainer.innerHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
                <div class="bg-slate-800 rounded-xl shadow-2xl max-w-sm w-full p-6 animate-scale-up">
                    <h3 class="text-lg font-bold text-white mb-4">Confirmação Necessária</h3>
                    <p class="text-slate-400 mb-6">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button data-modal-cancel class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 transition-colors">Cancelar</button>
                        <button data-modal-confirm class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">Confirmar</button>
                    </div>
                </div>
            </div>
        `;

        const modalElement = document.getElementById(modalId);
        const closeModal = () => (modalContainer.innerHTML = "");
        modalElement
          .querySelector("[data-modal-cancel]")
          .addEventListener("click", closeModal);
        modalElement
          .querySelector("[data-modal-confirm]")
          .addEventListener("click", () => {
            onConfirm();
            closeModal();
          });
      };

      // =================================================================================
      // RENDERIZAÇÃO DAS VIEWS
      // =================================================================================
      const renderSidebar = () => {
        const sidebar = document.getElementById("sidebar");
        sidebar.innerHTML = `
            <div class="p-4 flex flex-col h-full">
                <div class="flex items-center justify-between mb-8 px-2">
                    <h1 class="text-2xl font-bold text-white">Orça<span class="text-indigo-400">Fácil</span></h1>
                </div>
                <nav class="flex-1 space-y-2">
                     <a href="#dashboard-view" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> <span>Painel</span> </a>
                     <a href="#new-quote-view" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> <span>Novo Orçamento</span> </a>
                     <a href="#quotes-history-view" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2h2"></path></svg> <span>Histórico</span> </a>
                     <a href="#reports-view" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg> <span>Relatórios</span> </a>
                     <div class="pt-4 border-t border-slate-700/50">
                        <h5 class="px-3 text-xs font-semibold uppercase text-indigo-400 mb-2">Gerenciar</h5>
                        <a href="#clients-view" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> <span>Clientes</span> </a>
                        <a href="#products-view" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg> <span>Produtos/Serviços</span> </a>
                        <a href="#tasks-view" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg> <span>Tarefas</span> </a>
                        <a href="#profile-view" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> <span>Meu Perfil</span> </a>
                     </div>
                </nav>
                <div class="mt-auto pt-4 border-t border-slate-700/50 print-hide">
                    <button id="theme-toggle" type="button" class="w-full flex items-center justify-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-white transition-colors">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.95l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                        <span id="theme-toggle-text">Modo Claro</span>
                    </button>
                </div>
            </div>
        `;
      };

      const renderDashboard = () => {
        const view = document.getElementById("dashboard-view");
        const totalQuotes = state.quotes.filter(
          (q) => q.type === "quote"
        ).length;
        const totalRevenue = state.quotes
          .filter((q) => q.type === "receipt")
          .reduce((sum, q) => sum + q.total, 0);
        const totalClients = state.clients.length;
        const pendingTasks = state.tasks.filter(
          (t) => t.status === "Pendente"
        ).length;

        view.innerHTML = `
            <h2 class="text-3xl font-bold mb-6 text-white theme-sensitive-text">Painel de Controle</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg"> <h5 class="text-sm font-medium text-slate-400">Orçamentos em Aberto</h5> <p class="text-3xl font-bold text-white mt-1">${totalQuotes}</p> </div>
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg"> <h5 class="text-sm font-medium text-slate-400">Receita (Recibos)</h5> <p class="text-3xl font-bold text-white mt-1">${formatCurrency(
                  totalRevenue
                )}</p> </div>
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg"> <h5 class="text-sm font-medium text-slate-400">Clientes Ativos</h5> <p class="text-3xl font-bold text-white mt-1">${totalClients}</p> </div>
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg"> <h5 class="text-sm font-medium text-slate-400">Tarefas Pendentes</h5> <p class="text-3xl font-bold text-white mt-1">${pendingTasks}</p> </div>
            </div>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h3 class="font-bold text-lg text-white mb-4">Ações Rápidas</h3>
                    <div class="flex flex-col sm:flex-row gap-4">
                         <a href="#new-quote-view" class="nav-link-action flex-1 text-center bg-indigo-600 text-white p-4 rounded-lg shadow-indigo-500/30 glow-effect hover:-translate-y-1 transition-all"> <h4 class="font-bold">Novo Orçamento</h4> <p class="text-sm text-indigo-200">Criar um novo documento.</p> </a>
                         <a href="#clients-view" data-action="add-client" class="nav-link-action flex-1 text-center bg-slate-700 p-4 rounded-lg shadow-slate-600/20 glow-effect hover:-translate-y-1 transition-all"> <h4 class="font-bold text-white">Novo Cliente</h4> <p class="text-sm text-slate-400">Adicionar um cliente.</p> </a>
                    </div>
                </div>
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h3 class="font-bold text-lg text-white mb-4">Próximas Tarefas</h3>
                    <div id="dashboard-tasks-list" class="space-y-3"></div>
                </div>
            </div>
        `;
        const tasksListEl = view.querySelector("#dashboard-tasks-list");
        const upcomingTasks = state.tasks
          .filter((t) => t.status !== "Concluída")
          .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
          .slice(0, 5);
        if (upcomingTasks.length > 0) {
          tasksListEl.innerHTML = upcomingTasks
            .map(
              (task) =>
                `<div class="flex justify-between items-center p-3 rounded-lg bg-slate-700/50"> <span class="text-sm text-slate-300">${
                  task.description
                }</span> <span class="text-xs font-medium text-slate-400">${formatDate(
                  task.dueDate
                )}</span> </div>`
            )
            .join("");
        } else {
          tasksListEl.innerHTML =
            '<p class="text-sm text-slate-400">Nenhuma tarefa futura.</p>';
        }
        view
          .querySelector('[data-action="add-client"]')
          ?.addEventListener("click", (e) => {
            e.preventDefault();
            switchView("clients-view");
            setTimeout(
              () => document.querySelector("#add-client-btn")?.click(),
              50
            );
          });
      };

      const renderHistoryList = () => {
        const view = document.getElementById("quotes-history-view");
        const sortedQuotes = [...state.quotes].sort(
          (a, b) => parseInt(b.docNumber) - parseInt(a.docNumber)
        );
        view.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-white theme-sensitive-text">Histórico</h2>
                <a href="#new-quote-view" class="nav-link w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> <span>Novo Documento</span> </a>
            </div>
            <div class="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                            <tr>
                                <th scope="col" class="px-6 py-3">#</th> <th scope="col" class="px-6 py-3">Tipo</th> <th scope="col" class="px-6 py-3">Cliente</th> <th scope="col" class="px-6 py-3 hidden md:table-cell">Data</th> <th scope="col" class="px-6 py-3 text-right">Valor</th> <th scope="col" class="px-6 py-3 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            ${
                              sortedQuotes.length === 0
                                ? `<tr><td colspan="6" class="text-center py-10 text-slate-400">Nenhum documento encontrado.</td></tr>`
                                : ""
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        const tableBody = view.querySelector("#history-table-body");
        sortedQuotes.forEach((quote) => {
          const client = state.clients.find((c) => c.id === quote.clientId) || {
            name: "Cliente Removido",
          };
          const row = document.createElement("tr");
          row.className = "border-b border-slate-700 hover:bg-slate-700/50";
          row.innerHTML = `
                <td class="px-6 py-4 font-medium text-white">#${quote.docNumber
                  .toString()
                  .padStart(4, "0")}</td>
                <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${
                  quote.type === "receipt"
                    ? "bg-green-900 text-green-300"
                    : "bg-blue-900 text-blue-300"
                }">${
            quote.type === "receipt" ? "Recibo" : "Orçamento"
          }</span></td>
                <td class="px-6 py-4 text-slate-300">${client.name}</td>
                <td class="px-6 py-4 hidden md:table-cell text-slate-400">${formatDate(
                  quote.date
                )}</td>
                <td class="px-6 py-4 text-right text-slate-300">${formatCurrency(
                  quote.total
                )}</td>
                <td class="px-6 py-4 text-center">
                    <div class="flex items-center justify-center gap-2">
                       <button data-action="edit" data-id="${
                         quote.id
                       }" title="Editar" class="p-2 text-slate-400 hover:text-indigo-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                       ${
                         quote.type === "quote"
                           ? `<button data-action="convert" data-id="${quote.id}" title="Converter para Recibo" class="p-2 text-slate-400 hover:text-green-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>`
                           : ""
                       }
                       <button data-action="pdf" data-id="${
                         quote.id
                       }" title="Baixar PDF" class="p-2 text-slate-400 hover:text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                       <button data-action="delete" data-id="${
                         quote.id
                       }" title="Excluir" class="p-2 text-slate-400 hover:text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                </td>`;
          tableBody.appendChild(row);
        });

        view.addEventListener("click", (e) => {
          const button = e.target.closest("button[data-action]");
          if (!button) return;
          const { id, action } = button.dataset;
          if (action === "delete") {
            showConfirmModal(
              "Tem certeza que deseja excluir este documento? Esta ação não pode ser desfeita.",
              () => {
                state.quotes = state.quotes.filter((q) => q.id !== id);
                saveState();
                renderHistoryList();
                showToast("Documento excluído com sucesso.", "success");
              }
            );
          } else if (action === "pdf") {
            const quote = state.quotes.find((q) => q.id === id);
            const client = state.clients.find((c) => c.id === quote.clientId);
            generateQuotePDF({ quote, client, action: "download" });
          } else if (action === "convert") {
            showConfirmModal(
              "Tem certeza que deseja converter este orçamento em um recibo?",
              () => {
                const quote = state.quotes.find((q) => q.id === id);
                if (quote) {
                  quote.type = "receipt";
                  quote.receiptDate = new Date().toISOString();
                  quote.notes = `Orçamento pago em ${formatDate(
                    quote.receiptDate
                  )}`;
                  saveState();
                  renderHistoryList();
                  showToast("Orçamento convertido para recibo.", "success");
                }
              }
            );
          } else if (action === "edit") {
            switchView("new-quote-view", id);
          }
        });
      };

      const renderProductsList = () => {
        const view = document.getElementById("products-view");
        view.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-white theme-sensitive-text">Produtos e Serviços</h2>
                <button id="add-product-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> <span>Novo Item</span> </button>
            </div>
            <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                ${
                  state.products.length === 0
                    ? '<p class="col-span-full text-center py-10 text-slate-400">Nenhum produto ou serviço cadastrado.</p>'
                    : ""
                }
            </div>
        `;
        const grid = view.querySelector("#products-grid");
        state.products.forEach((product) => {
          const card = document.createElement("div");
          card.className =
            "bg-slate-800 rounded-xl shadow-lg flex flex-col transition-transform hover:-translate-y-1";
          card.innerHTML = `
                <div class="p-6 flex-1">
                    <h4 class="font-bold text-lg text-white">${
                      product.name
                    }</h4>
                    <p class="text-sm text-slate-400 mt-2 h-16 overflow-hidden">${
                      product.description || "Sem descrição."
                    }</p>
                    <p class="text-2xl font-bold text-indigo-400 mt-4">${formatCurrency(
                      product.price
                    )}</p>
                </div>
                <div class="bg-slate-800/50 p-3 flex justify-end gap-2 rounded-b-xl border-t border-slate-700">
                    <button data-action="edit" data-id="${
                      product.id
                    }" class="text-sm px-3 py-1 rounded-md text-slate-300 hover:bg-slate-700">Editar</button>
                    <button data-action="delete" data-id="${
                      product.id
                    }" class="text-sm px-3 py-1 rounded-md text-red-400 hover:bg-red-900/50">Excluir</button>
                </div>`;
          grid.appendChild(card);
        });
        view
          .querySelector("#add-product-btn")
          .addEventListener("click", () => renderProductModal());
        view.addEventListener("click", (e) => {
          const button = e.target.closest("button[data-action]");
          if (!button) return;
          const id = button.dataset.id;
          const action = button.dataset.action;

          if (action === "edit") renderProductModal(id);
          if (action === "delete") {
            showConfirmModal(
              "Deseja excluir este item? Ele será removido de orçamentos não finalizados.",
              () => {
                state.products = state.products.filter((p) => p.id !== id);
                saveState();
                renderProductsList();
                showToast("Produto/Serviço excluído.", "success");
              }
            );
          }
        });
      };

      const renderClientsList = () => {
        const view = document.getElementById("clients-view");
        view.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-white theme-sensitive-text">Clientes</h2>
                <button id="add-client-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> <span>Novo Cliente</span> </button>
            </div>
            <div id="clients-list-container" class="space-y-4">
                 ${
                   state.clients.length === 0
                     ? '<p class="text-center py-10 text-slate-400">Nenhum cliente cadastrado.</p>'
                     : ""
                 }
            </div>
        `;
        const container = view.querySelector("#clients-list-container");
        state.clients.forEach((client) => {
          const item = document.createElement("div");
          item.className =
            "bg-slate-800 p-4 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4";
          let fullAddress = client.street
            ? `${client.street}, ${client.number || "s/n"}${
                client.neighborhood ? " - " + client.neighborhood : ""
              }`
            : client.address || "Endereço não informado";
          let docInfo = client.docNumber
            ? `${(client.docType || "doc").toUpperCase()}: ${client.docNumber}`
            : ""; // Changed from client.cpfCnpj to client.docNumber based on schema

          item.innerHTML = `
                <div class="flex-1">
                    <p class="font-bold text-white">${client.name}</p>
                    <p class="text-sm text-slate-400">${
                      client.email || "Email não informado"
                    }</p>
                    <p class="text-sm text-slate-400 mt-1">${fullAddress}</p>
                    ${
                      client.notes
                        ? `<p class="text-xs text-slate-400 mt-2 pt-2 border-t border-slate-700"><b>Obs:</b> ${client.notes}</p>`
                        : ""
                    }
                    <div class="flex items-center flex-wrap gap-x-4 gap-y-2 mt-2">
                        ${
                          docInfo
                            ? `<span class="text-xs font-mono bg-slate-700 px-2 py-0.5 rounded">${docInfo}</span>`
                            : ""
                        }
                        ${
                          client.phone
                            ? `<span class="text-xs text-slate-400">${client.phone}</span>`
                            : ""
                        }
                    </div>
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                     <button data-action="edit" data-id="${
                       client.id
                     }" class="flex-1 sm:flex-initial text-sm px-3 py-1 rounded-md text-slate-300 hover:bg-slate-700">Editar</button>
                    <button data-action="delete" data-id="${
                      client.id
                    }" class="flex-1 sm:flex-initial text-sm px-3 py-1 rounded-md text-red-400 hover:bg-red-900/50">Excluir</button>
                </div>`;
          container.appendChild(item);
        });
        view
          .querySelector("#add-client-btn")
          .addEventListener("click", () => renderClientModal());
        view.addEventListener("click", (e) => {
          const button = e.target.closest("button[data-action]");
          if (!button) return;
          const id = button.dataset.id;
          if (button.dataset.action === "edit") {
            renderClientModal(id);
          } else if (button.dataset.action === "delete") {
            if (state.quotes.some((q) => q.clientId === id)) {
              showToast(
                "Não é possível excluir um cliente associado a um orçamento.",
                "error"
              );
              return;
            }
            showConfirmModal(
              "Tem certeza que deseja excluir este cliente?",
              () => {
                state.clients = state.clients.filter((c) => c.id !== id);
                saveState();
                renderClientsList();
                showToast("Cliente excluído com sucesso.", "success");
              }
            );
          }
        });
      };

      const renderTasksList = () => {
        const view = document.getElementById("tasks-view");
        const statuses = ["Pendente", "Em Andamento", "Concluída"];

        view.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-white theme-sensitive-text">Lista de Tarefas</h2>
                    <button id="add-task-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>Nova Tarefa</span>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    ${statuses
                      .map(
                        (status) => `
                        <div class="bg-slate-800/50 rounded-xl p-4">
                            <h3 class="font-bold text-center text-white mb-4">${status}</h3>
                            <div class="space-y-3" id="tasks-status-${status.replace(
                              " ",
                              "-"
                            )}">
                                <!-- As tarefas são inseridas aqui -->
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;

        state.tasks
          .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
          .forEach((task) => {
            const containerId = `tasks-status-${task.status.replace(" ", "-")}`;
            const container = view.querySelector(`#${containerId}`);
            if (container) {
              const client = task.clientId
                ? state.clients.find((c) => c.id === task.clientId)
                : null;
              const clientInfoHTML = client
                ? `
                    <div class="mt-2 pt-2 border-t border-slate-600 flex items-center gap-2 text-xs text-indigo-400 font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        <span>${client.name}</span>
                    </div>`
                : "";

              const taskCard = document.createElement("div");
              taskCard.className = "bg-slate-700 p-4 rounded-lg shadow-md";
              taskCard.innerHTML = `
                    <p class="text-slate-200">${task.description}</p>
                    ${clientInfoHTML}
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-xs text-slate-400">${formatDate(
                          task.dueDate
                        )}</span>
                        <div class="flex gap-1">
                            <button data-action="edit" data-id="${
                              task.id
                            }" class="p-1 rounded-full hover:bg-slate-600"><svg class="w-4 h-4 text-slate-400" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                            <button data-action="delete" data-id="${
                              task.id
                            }" class="p-1 rounded-full hover:bg-slate-600"><svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>
                        </div>
                    </div>
                `;
              container.appendChild(taskCard);
            }
          });
        view
          .querySelector("#add-task-btn")
          .addEventListener("click", () => renderTaskModal());
        view.addEventListener("click", (e) => {
          const button = e.target.closest("button[data-action]");
          if (!button) return;
          const id = button.dataset.id;
          const action = button.dataset.action;
          if (action === "edit") {
            renderTaskModal(id);
          }
          if (action === "delete") {
            showConfirmModal(
              "Tem certeza que deseja excluir esta tarefa?",
              () => {
                state.tasks = state.tasks.filter((t) => t.id !== id);
                saveState();
                renderTasksList();
                showToast("Tarefa excluída.", "success");
              }
            );
          }
        });
      };

      const renderNewQuote = (quoteIdToEdit = null) => {
        const isEditing = quoteIdToEdit !== null;
        if (isEditing) {
          const sourceQuote = state.quotes.find((q) => q.id === quoteIdToEdit);
          state.currentQuote = JSON.parse(JSON.stringify(sourceQuote));
        } else {
          state.currentQuote = {
            id: generateUniqueId(),
            docNumber: state.nextQuoteNumber.toString().padStart(4, "0"),
            clientId: "",
            items: [],
            total: 0,
            date: new Date().toISOString(),
            dueDate: new Date(
              Date.now() + 30 * 24 * 60 * 60 * 1000
            ).toISOString(),
            notes: "Validade da proposta: 30 dias. Agradecemos a preferência!",
            type: "quote",
          };
        }
        const quote = state.currentQuote;
        const view = document.getElementById("new-quote-view");
        const initialClient = state.clients.find(
          (c) => c.id === quote.clientId
        );
        view.innerHTML = `
            <h2 class="text-3xl font-bold text-white mb-6 theme-sensitive-text">${
              isEditing
                ? `Editando ${
                    quote.type === "receipt" ? "Recibo" : "Orçamento"
                  } #${quote.docNumber}`
                : "Criar Novo Orçamento"
            }</h2>
            <form id="quote-form" class="space-y-8" autocomplete="off">
                <!-- Informações do Cliente -->
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h3 class="font-bold text-lg mb-4 text-white">1. Informações do Cliente</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative">
                            <label for="client-search-input" class="block text-sm font-medium text-slate-300 mb-1">Pesquisar Cliente</label>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="client-search-input" placeholder="Digite para buscar..." class="w-full bg-slate-700 border-slate-600 rounded-lg p-2.5 text-white">
                                <button id="add-client-quick-btn" type="button" class="flex-shrink-0 bg-indigo-500 text-white px-3 py-2.5 rounded-lg hover:bg-indigo-600 transition-colors flex items-center justify-center gap-2"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> <span class="text-sm">Novo Cliente</span> </button>
                            </div>
                            <div id="client-suggestions" class="absolute z-10 w-full bg-slate-600 border border-slate-500 rounded-md shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                        </div>
                        <div id="client-details" class="text-sm text-slate-400 p-2.5 bg-slate-700/50 rounded-lg min-h-[76px] flex flex-col justify-center"></div>
                    </div>
                </div>
                <!-- Itens do Orçamento -->
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h3 class="font-bold text-lg mb-4 text-white">2. Itens do Orçamento</h3>
                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm">
                            <thead> <tr class="border-b border-slate-700"> <th class="text-left p-2">Item</th> <th class="text-center p-2 w-32">Qtd</th> <th class="text-right p-2 w-32">Preço Unit.</th> <th class="text-right p-2 w-32">Subtotal</th> <th class="text-center p-2 w-16"></th> </tr> </thead>
                            <tbody id="quote-items-table"></tbody>
                        </table>
                    </div>
                    <div class="relative">
                        <label for="product-search-input" class="sr-only">Adicionar Produto/Serviço</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="product-search-input" placeholder="Pesquise ou adicione um produto/serviço..." class="w-full bg-slate-700 border-slate-600 rounded-lg p-2.5 text-white">
                            <button id="add-product-quick-btn" type="button" class="flex-shrink-0 bg-indigo-500 text-white px-3 py-2.5 rounded-lg hover:bg-indigo-600 transition-colors flex items-center justify-center gap-2"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> <span class="text-sm">Novo Produto</span> </button>
                        </div>
                        <div id="product-suggestions" class="absolute z-10 w-full bg-slate-600 border border-slate-500 rounded-md shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
                 <!-- Total e Notas -->
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4 text-white">3. Notas Adicionais</h3>
                        <textarea id="quote-notes" class="w-full h-24 bg-slate-700 border-slate-600 rounded-lg p-2.5 text-white">${
                          quote.notes
                        }</textarea>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col justify-center">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-medium text-slate-300">Total:</span>
                            <span id="quote-total" class="text-3xl font-bold text-indigo-400">${formatCurrency(
                              quote.total
                            )}</span>
                        </div>
                    </div>
                </div>
                <!-- Ações -->
                <div class="flex flex-col sm:flex-row justify-between items-center pt-6 border-t border-slate-700 gap-4">
                    <div class="flex flex-col items-center sm:items-start gap-3 w-full sm:w-auto">
                        <div class="flex items-center gap-2 flex-wrap justify-center sm:justify-start">
                            <button type="submit" class="w-full sm:w-auto px-4 py-3 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors flex items-center justify-center gap-2"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293z" /><path fill-rule="evenodd" d="M17 3a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1h14z" clip-rule="evenodd"/></svg> <span>${
                              isEditing ? "Atualizar" : "Salvar"
                            }</span> </button>
                            <button type="button" id="preview-pdf-btn" title="Visualizar PDF" class="p-3 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg> </button>
                            <button type="button" id="download-pdf-btn" title="Baixar PDF" class="p-3 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> </button>
                            <button type="button" id="share-btn" title="Compartilhar" class="p-3 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg> </button>
                        </div>
                        ${
                          quote.type !== "receipt"
                            ? `
                        <div class="flex items-center gap-2 w-full sm:w-auto flex-wrap justify-center sm:justify-start">
                            <button type="button" id="convert-to-receipt-btn" class="w-full sm:w-auto px-4 py-3 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition-colors flex items-center justify-center gap-2"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> <span>${
                              isEditing ? "Converter" : "Salvar como Recibo"
                            }</span> </button>
                            <button type="button" id="preview-pdf-btn-receipt" title="Visualizar Recibo" class="p-3 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg> </button>
                            <button type="button" id="download-pdf-btn-receipt" title="Baixar Recibo" class="p-3 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> </button>
                            <button type="button" id="share-btn-receipt" title="Compartilhar Recibo" class="p-3 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg> </button>
                        </div>`
                            : ""
                        }
                    </div>
                    <div class="ml-auto w-full sm:w-auto">
                        <button type="button" id="cancel-quote-btn" class="w-full px-6 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300">Cancelar</button>
                    </div>
                </div>
            </form>
        `;
        const form = view.querySelector("#quote-form");
        const clientSearchInput = view.querySelector("#client-search-input");
        const clientSuggestions = view.querySelector("#client-suggestions");
        const productSearchInput = view.querySelector("#product-search-input");
        const productSuggestions = view.querySelector("#product-suggestions");
        view
          .querySelector("#add-client-quick-btn")
          .addEventListener("click", () =>
            renderClientModal(null, (newClient) => selectClient(newClient))
          );
        view
          .querySelector("#add-product-quick-btn")
          .addEventListener("click", () =>
            renderProductModal(null, (newProduct) =>
              addProductToQuote(newProduct)
            )
          );
        const updateQuoteTotal = () => {
          quote.total = quote.items.reduce(
            (sum, item) => sum + item.quantity * item.price,
            0
          );
          view.querySelector("#quote-total").textContent = formatCurrency(
            quote.total
          );
        };
        const renderQuoteItems = () => {
          const tableBody = view.querySelector("#quote-items-table");
          tableBody.innerHTML = "";
          quote.items.forEach((item, index) => {
            const row = document.createElement("tr");
            row.className = "border-b border-slate-700/50";
            row.innerHTML = `
                    <td class="p-2 text-slate-300">${item.name}</td>
                    <td class="p-2">
                         <div class="flex items-center justify-center space-x-2">
                            <button type="button" data-action="decrease-qty" data-index="${index}" class="w-7 h-7 flex items-center justify-center text-lg rounded-md bg-slate-600 hover:bg-slate-500 transition-colors">-</button>
                            <span class="font-medium w-8 text-center text-slate-300">${
                              item.quantity
                            }</span>
                            <button type="button" data-action="increase-qty" data-index="${index}" class="w-7 h-7 flex items-center justify-center text-lg rounded-md bg-slate-600 hover:bg-slate-500 transition-colors">+</button>
                        </div>
                    </td>
                    <td class="p-2 text-right text-slate-300">${formatCurrency(
                      item.price
                    )}</td>
                    <td class="p-2 text-right font-medium text-slate-300">${formatCurrency(
                      item.quantity * item.price
                    )}</td>
                    <td class="p-2 text-center"><button type="button" data-action="remove-item" data-index="${index}" class="p-1 text-red-400 hover:bg-red-900/50 rounded-full"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></button></td>`;
            tableBody.appendChild(row);
          });
          updateQuoteTotal();
        };
        const updateClientDetails = (clientId) => {
          const client = state.clients.find((c) => c.id === clientId);
          const detailsDiv = view.querySelector("#client-details");
          if (client) {
            let fullAddress = client.street
              ? `${client.street}, ${client.number || "s/n"} - ${
                  client.city
                }, ${client.state}`
              : client.address || "";
            let docInfo = client.docNumber
              ? `<span class="text-xs font-mono bg-slate-900/50 px-2 py-0.5 rounded">${client.docType.toUpperCase()}: ${
                  client.docNumber
                }</span>`
              : "";
            detailsDiv.innerHTML = `<p class="font-semibold text-white">${
              client.name
            }</p><p class="text-slate-400">${
              client.email
            }</p><p class="text-slate-400 mt-1">${fullAddress}</p><div class="mt-2 flex flex-wrap gap-x-4 gap-y-1">${docInfo}${
              client.phone
                ? `<span class="text-xs text-slate-400">Tel: ${client.phone}</span>`
                : ""
            }</div>`;
          } else {
            detailsDiv.innerHTML =
              "<p>Selecione um cliente para ver os detalhes.</p>";
          }
        };
        const selectClient = (client) => {
          state.currentQuote.clientId = client.id;
          clientSearchInput.value = client.name;
          updateClientDetails(client.id);
          clientSuggestions.classList.add("hidden");
          clientSuggestions.innerHTML = "";
          clientSearchInput.blur();
        };
        if (initialClient) {
          clientSearchInput.value = initialClient.name;
          updateClientDetails(initialClient.id);
        }
        clientSearchInput.addEventListener("input", () => {
          const searchTerm = clientSearchInput.value.toLowerCase();
          clientSuggestions.innerHTML = "";
          if (searchTerm.length === 0) {
            clientSuggestions.classList.add("hidden");
            return;
          }
          const filteredClients = state.clients.filter((client) =>
            client.name.toLowerCase().includes(searchTerm)
          );
          if (filteredClients.length > 0) {
            filteredClients.forEach((client) => {
              const item = document.createElement("div");
              item.className =
                "px-4 py-2 text-white hover:bg-indigo-500 cursor-pointer";
              item.textContent = client.name;
              item.dataset.clientId = client.id;
              clientSuggestions.appendChild(item);
            });
          }
          clientSuggestions.classList.remove("hidden");
        });
        clientSuggestions.addEventListener("click", (e) => {
          if (e.target.dataset.clientId) {
            const client = state.clients.find(
              (c) => c.id === e.target.dataset.clientId
            );
            if (client) selectClient(client);
          }
        });
        const addProductToQuote = (product) => {
          if (product) {
            const existingItem = quote.items.find(
              (item) => item.productId === product.id
            );
            if (existingItem) {
              existingItem.quantity++;
            } else {
              quote.items.push({
                productId: product.id,
                name: product.name,
                price: product.price,
                quantity: 1,
              });
            }
            renderQuoteItems();
            productSearchInput.value = "";
            productSuggestions.classList.add("hidden");
            productSuggestions.innerHTML = "";
            productSearchInput.blur();
          }
        };
        productSearchInput.addEventListener("input", () => {
          const searchTerm = productSearchInput.value.toLowerCase();
          productSuggestions.innerHTML = "";
          if (searchTerm.length === 0) {
            productSuggestions.classList.add("hidden");
            return;
          }
          const filteredProducts = state.products.filter((p) =>
            p.name.toLowerCase().includes(searchTerm)
          );
          if (filteredProducts.length > 0) {
            filteredProducts.forEach((product) => {
              const item = document.createElement("div");
              item.className =
                "px-4 py-2 text-white hover:bg-indigo-500 cursor-pointer";
              item.textContent = `${product.name} - ${formatCurrency(
                product.price
              )}`;
              item.dataset.productId = product.id;
              productSuggestions.appendChild(item);
            });
          }
          productSuggestions.classList.remove("hidden");
        });
        productSuggestions.addEventListener("click", (e) => {
          if (e.target.dataset.productId) {
            const product = state.products.find(
              (p) => p.id === e.target.dataset.productId
            );
            if (product) addProductToQuote(product);
          }
        });
        document.addEventListener("click", (e) => {
          if (
            !clientSearchInput.contains(e.target) &&
            !clientSuggestions.contains(e.target)
          )
            clientSuggestions.classList.add("hidden");
          if (
            !productSearchInput.contains(e.target) &&
            !productSuggestions.contains(e.target)
          )
            productSuggestions.classList.add("hidden");
        });
        const getCurrentQuoteFromForm = () => {
          if (!state.currentQuote) return null;
          const currentData = { ...state.currentQuote };
          currentData.notes = view.querySelector("#quote-notes").value;
          return currentData;
        };
        view
          .querySelector("#quote-items-table")
          .addEventListener("click", (e) => {
            const button = e.target.closest("button[data-action]");
            if (!button) return;
            const { action, index } = button.dataset;
            if (action === "remove-item") quote.items.splice(index, 1);
            else if (action === "increase-qty") quote.items[index].quantity++;
            else if (
              action === "decrease-qty" &&
              quote.items[index].quantity > 1
            )
              quote.items[index].quantity--;
            renderQuoteItems();
          });
        const saveDocument = (saveAsType) => {
          if (!state.currentQuote.clientId) {
            showToast("Por favor, selecione um cliente.", "error");
            return;
          }
          if (state.currentQuote.items.length === 0) {
            showToast("Adicione pelo menos um item ao documento.", "error");
            return;
          }
          const quoteToSave = { ...state.currentQuote, type: saveAsType };
          quoteToSave.notes = view.querySelector("#quote-notes").value;
          if (quoteToSave.type === "receipt" && !quoteToSave.receiptDate)
            quoteToSave.receiptDate = new Date().toISOString();
          const existingQuoteIndex = state.quotes.findIndex(
            (q) => q.id === quoteToSave.id
          );
          if (existingQuoteIndex > -1)
            state.quotes[existingQuoteIndex] = quoteToSave;
          else {
            state.quotes.push(quoteToSave);
            state.nextQuoteNumber++;
          }
          saveState();
          showToast(`Documento salvo com sucesso!`, "success");
          switchView("quotes-history-view");
        };
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          saveDocument(
            isEditing && quote.type === "receipt" ? "receipt" : "quote"
          );
        });
        view
          .querySelector("#convert-to-receipt-btn")
          ?.addEventListener("click", () => {
            showConfirmModal(
              "Tem certeza que deseja converter para recibo?",
              () => saveDocument("receipt")
            );
          });
        const handlePdfAction = (action, docType) => {
          const quoteData = getCurrentQuoteFromForm();
          const client = state.clients.find((c) => c.id === quoteData.clientId);
          if (!client) {
            showToast("Selecione um cliente para gerar o PDF.", "error");
            return;
          }
          const tempQuote = { ...quoteData, type: docType };
          if (action === "share") shareQuote(tempQuote, client);
          else generateQuotePDF({ quote: tempQuote, client, action });
        };
        view
          .querySelector("#preview-pdf-btn")
          ?.addEventListener("click", () =>
            handlePdfAction("preview", "quote")
          );
        view
          .querySelector("#download-pdf-btn")
          ?.addEventListener("click", () =>
            handlePdfAction("download", "quote")
          );
        view
          .querySelector("#share-btn")
          ?.addEventListener("click", () => handlePdfAction("share", "quote"));
        view
          .querySelector("#preview-pdf-btn-receipt")
          ?.addEventListener("click", () =>
            handlePdfAction("preview", "receipt")
          );
        view
          .querySelector("#download-pdf-btn-receipt")
          ?.addEventListener("click", () =>
            handlePdfAction("download", "receipt")
          );
        view
          .querySelector("#share-btn-receipt")
          ?.addEventListener("click", () =>
            handlePdfAction("share", "receipt")
          );
        view
          .querySelector("#cancel-quote-btn")
          .addEventListener("click", () => {
            showConfirmModal(
              "Deseja cancelar? As alterações não serão salvas.",
              () => switchView("dashboard-view")
            );
          });
        renderQuoteItems();
        if (initialClient) updateClientDetails(initialClient.id);
      };

      const renderProfileView = () => {
        const view = document.getElementById("profile-view");
        const provider = state.provider;

        view.innerHTML = `
            <h2 class="text-3xl font-bold text-white mb-6 theme-sensitive-text">Meu Perfil</h2>
            <form id="profile-form" class="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-lg space-y-6">
                <div class="flex flex-col sm:flex-row items-center gap-6">
                    <div class="relative">
                        <img id="logo-preview" src="${
                          provider.logoUrl ||
                          "https://placehold.co/128x128/e2e8f0/94a3b8?text=Logo"
                        }" alt="Logo da Empresa" class="w-32 h-32 rounded-full object-cover border-4 border-slate-700">
                        <label for="logo-upload" class="absolute -bottom-2 -right-2 bg-indigo-600 text-white p-2 rounded-full cursor-pointer hover:bg-indigo-700 transition-transform hover:scale-110">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </label>
                        <input type="file" id="logo-upload" class="hidden" accept="image/png, image/jpeg, image/gif">
                    </div>
                    <div class="flex-1 text-center sm:text-left">
                         <h3 class="text-2xl font-bold text-white">${
                           provider.name
                         }</h3>
                         <p class="text-slate-400">${provider.docNumber}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-slate-700">
                    <div> <label for="provider-name" class="block text-sm font-medium mb-1">Nome da Empresa</label> <input type="text" id="provider-name" value="${
                      provider.name
                    }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                     <div class="flex items-end gap-2">
                         <div class="flex-shrink-0"> <label for="provider-docType" class="block text-sm font-medium mb-1">Tipo</label> <select id="provider-docType" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> <option value="cnpj" ${
                           provider.docType === "cnpj" ? "selected" : ""
                         }>CNPJ</option> <option value="cpf" ${
          provider.docType === "cpf" ? "selected" : ""
        }>CPF</option> </select> </div>
                         <div class="flex-grow"> <label for="provider-docNumber" class="block text-sm font-medium mb-1">Número do Documento</label> <input type="text" id="provider-docNumber" value="${
                           provider.docNumber
                         }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                     </div>
                     <div> <label for="provider-email" class="block text-sm font-medium mb-1">Email de Contato</label> <input type="email" id="provider-email" value="${
                       provider.email
                     }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                     <div> <label for="provider-phone" class="block text-sm font-medium mb-1">Telefone</label> <input type="tel" id="provider-phone" value="${
                       provider.phone
                     }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                     <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-1"> <label for="provider-cep" class="block text-sm font-medium mb-1 text-slate-300">CEP</label> <input type="text" id="provider-cep" value="${
                          provider.cep || ""
                        }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                     </div>
                     <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-2"> <label for="provider-street" class="block text-sm font-medium mb-1 text-slate-300">Rua</label> <input type="text" id="provider-street" value="${
                          provider.street || ""
                        }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                        <div> <label for="provider-number" class="block text-sm font-medium mb-1 text-slate-300">Número</label> <input type="text" id="provider-number" value="${
                          provider.number || ""
                        }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                     </div>
                     <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div> <label for="provider-neighborhood" class="block text-sm font-medium mb-1 text-slate-300">Bairro</label> <input type="text" id="provider-neighborhood" value="${
                          provider.neighborhood || ""
                        }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                        <div> <label for="provider-city" class="block text-sm font-medium mb-1 text-slate-300">Cidade</label> <input type="text" id="provider-city" value="${
                          provider.city || ""
                        }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                        <div> <label for="provider-state" class="block text-sm font-medium mb-1 text-slate-300">Estado (UF)</label> <input type="text" id="provider-state" value="${
                          provider.state || ""
                        }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                     </div>
                </div>

                <div class="flex justify-end pt-6 border-t border-slate-700">
                    <button type="submit" class="w-full sm:w-auto bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">Salvar Alterações</button>
                </div>
            </form>
        `;
        const profileForm = view.querySelector("#profile-form");
        const providerDocTypeSelect =
          profileForm.querySelector("#provider-docType");
        const providerDocNumberInput = profileForm.querySelector(
          "#provider-docNumber"
        );
        const providerPhoneInput = profileForm.querySelector("#provider-phone");
        const providerCepInput = profileForm.querySelector("#provider-cep");

        const updateProviderDocInputMask = () => {
          const type = providerDocTypeSelect.value;
          // Only clear if the type changes to avoid clearing user input mid-typing
          if (type !== (state.provider.docType || "cnpj")) {
            providerDocNumberInput.value = "";
          }
          if (type === "cpf") {
            providerDocNumberInput.placeholder = "000.000.000-00";
            providerDocNumberInput.maxLength = 14;
          } else {
            providerDocNumberInput.placeholder = "00.000.000/0001-00";
            providerDocNumberInput.maxLength = 18;
          }
        };

        providerDocTypeSelect.addEventListener(
          "change",
          updateProviderDocInputMask
        );
        providerDocNumberInput.addEventListener("input", (e) => {
          e.target.value = maskDocument(
            e.target.value,
            providerDocTypeSelect.value
          );
        });
        providerPhoneInput.addEventListener("input", (e) => {
          e.target.value = maskPhone(e.target.value);
        });
        providerCepInput.addEventListener("input", (e) => {
          e.target.value = maskCep(e.target.value);
        });
        providerCepInput.addEventListener("blur", (e) =>
          fetchAddressByCep(e.target.value, profileForm, "provider")
        ); // Pass 'provider' to differentiate form fields

        // Apply initial masks on load
        updateProviderDocInputMask();
        providerDocNumberInput.value = maskDocument(
          state.provider.docNumber,
          state.provider.docType
        );
        providerPhoneInput.value = maskPhone(state.provider.phone);
        providerCepInput.value = maskCep(state.provider.cep);

        profileForm.addEventListener("submit", (e) => {
          e.preventDefault();
          state.provider.name =
            profileForm.querySelector("#provider-name").value;
          state.provider.docType =
            profileForm.querySelector("#provider-docType").value;
          state.provider.docNumber = profileForm.querySelector(
            "#provider-docNumber"
          ).value;
          state.provider.email =
            profileForm.querySelector("#provider-email").value;
          state.provider.phone =
            profileForm.querySelector("#provider-phone").value;
          // Update provider address fields from the form
          state.provider.cep = profileForm.querySelector("#provider-cep").value;
          state.provider.street =
            profileForm.querySelector("#provider-street").value;
          state.provider.number =
            profileForm.querySelector("#provider-number").value;
          state.provider.neighborhood = profileForm.querySelector(
            "#provider-neighborhood"
          ).value;
          state.provider.city =
            profileForm.querySelector("#provider-city").value;
          state.provider.state =
            profileForm.querySelector("#provider-state").value;

          // The 'address' field in provider can be a summary or deprecated if detailed fields are used
          // For now, let's keep it consistent with the form, if detailed fields are empty, use the generic address
          if (!state.provider.street) {
            state.provider.address =
              profileForm.querySelector("#provider-address").value;
          } else {
            state.provider.address = `${state.provider.street}, ${state.provider.number} - ${state.provider.neighborhood}, ${state.provider.city} - ${state.provider.state}`;
          }

          state.provider.logoUrl =
            profileForm.querySelector("#logo-preview").src;
          saveState();
          showToast("Perfil atualizado com sucesso!", "success");
          renderProfileView();
        });
        profileForm
          .querySelector("#logo-upload")
          .addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                profileForm.querySelector("#logo-preview").src =
                  event.target.result;
              };
              reader.readAsDataURL(file);
            }
          });
      };

      const renderReportsView = () => {
        const view = document.getElementById("reports-view");
        view.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-white theme-sensitive-text">Central de Relatórios</h2>
                <div class="flex items-center gap-2 print-hide">
                    <button id="preview-report-btn" title="Visualizar PDF" class="p-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg> </button>
                    <button id="download-report-btn" title="Baixar PDF" class="p-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> </button>
                    <button id="share-report-btn" title="Compartilhar" class="p-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-colors"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg> </button>
                </div>
            </div>
            <div class="bg-slate-800 p-4 sm:p-6 rounded-xl shadow-lg">
                <div class="border-b border-slate-700 print-hide">
                    <nav class="-mb-px flex space-x-4 sm:space-x-8 overflow-x-auto" aria-label="Tabs">
                        <button data-tab="financial" class="report-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-400 border-indigo-400">Financeiro</button>
                        <button data-tab="documents" class="report-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent">Documentos</button>
                        <button data-tab="clients" class="report-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent">Clientes</button>
                        <button data-tab="products" class="report-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-400 border-transparent">Produtos</button>
                    </nav>
                </div>
                <div id="report-content" class="mt-6"></div>
            </div>
        `;
        const handleTabClick = (e) => {
          const tabButton = e.target.closest(".report-tab");
          if (!tabButton) return;
          view
            .querySelectorAll(".report-tab")
            .forEach((tab) =>
              tab.classList.remove("text-indigo-400", "border-indigo-400")
            );
          tabButton.classList.add("text-indigo-400", "border-indigo-400");
          renderReportContent(tabButton.dataset.tab);
        };
        view.addEventListener("click", handleTabClick);
        view
          .querySelector("#preview-report-btn")
          .addEventListener("click", () => generateReportPDF("preview"));
        view
          .querySelector("#download-report-btn")
          .addEventListener("click", () => generateReportPDF("download"));
        view
          .querySelector("#share-report-btn")
          .addEventListener("click", () => generateReportPDF("share"));
        renderReportContent("financial");
      };

      const renderReportContent = (tabId) => {
        const contentDiv = document.getElementById("report-content");
        if (!contentDiv) return;
        const renderMap = {
          financial: renderFinancialReport,
          documents: renderDocumentsReport,
          clients: renderClientSalesReport,
          products: renderProductSalesReport,
        };
        renderMap[tabId](contentDiv);
      };

      const renderFinancialReport = (container) => {
        const receipts = state.quotes.filter((q) => q.type === "receipt");
        const openQuotes = state.quotes.filter((q) => q.type === "quote");
        const totalRevenue = receipts.reduce((sum, q) => sum + q.total, 0);
        const totalOpen = openQuotes.reduce((sum, q) => sum + q.total, 0);
        const averageTicket =
          receipts.length > 0 ? totalRevenue / receipts.length : 0;
        container.innerHTML = `
            <h3 class="text-xl font-bold mb-4 text-white">Resumo Financeiro</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-700/50 p-6 rounded-lg"> <h4 class="text-sm font-medium text-slate-400">Total Faturado (Recibos)</h4> <p class="text-3xl font-bold mt-1 text-green-400">${formatCurrency(
                  totalRevenue
                )}</p> </div>
                <div class="bg-slate-700/50 p-6 rounded-lg"> <h4 class="text-sm font-medium text-slate-400">Total em Aberto (Orçamentos)</h4> <p class="text-3xl font-bold mt-1 text-yellow-400">${formatCurrency(
                  totalOpen
                )}</p> </div>
                <div class="bg-slate-700/50 p-6 rounded-lg"> <h4 class="text-sm font-medium text-slate-400">Ticket Médio (Recibos)</h4> <p class="text-3xl font-bold mt-1 text-blue-400">${formatCurrency(
                  averageTicket
                )}</p> </div>
            </div>
        `;
      };

      const renderDocumentsReport = (container) => {
        container.innerHTML = `
             <h3 class="text-xl font-bold mb-4 text-white">Relatório de Documentos</h3>
             <div class="print-hide bg-slate-700/50 p-4 rounded-lg mb-6 flex flex-col sm:flex-row gap-4 items-center">
                 <div class="flex-1 w-full"> <label for="report-start-date" class="block text-sm font-medium mb-1">Data Início</label> <input type="date" id="report-start-date" class="w-full bg-slate-600 rounded-lg p-2.5"> </div>
                 <div class="flex-1 w-full"> <label for="report-end-date" class="block text-sm font-medium mb-1">Data Fim</label> <input type="date" id="report-end-date" class="w-full bg-slate-600 rounded-lg p-2.5"> </div>
                 <div class="flex-1 w-full"> <label for="report-doc-type" class="block text-sm font-medium mb-1">Tipo</label> <select id="report-doc-type" class="w-full bg-slate-600 rounded-lg p-2.5"> <option value="all">Todos</option> <option value="quote">Orçamentos</option> <option value="receipt">Recibos</option> </select> </div>
                 <div class="w-full sm:w-auto pt-5"> <button id="generate-doc-report" class="w-full bg-indigo-600 text-white px-4 py-2.5 rounded-lg hover:bg-indigo-700">Gerar</button> </div>
             </div>
             <div id="doc-report-results" class="overflow-x-auto"></div>
        `;
        document
          .getElementById("generate-doc-report")
          .addEventListener("click", () => {
            const startDate =
              document.getElementById("report-start-date").value;
            const endDate = document.getElementById("report-end-date").value;
            const docType = document.getElementById("report-doc-type").value;
            let filteredQuotes = state.quotes.filter((q) => {
              const qDate = new Date(q.date);
              const start = startDate ? new Date(startDate) : null;
              const end = endDate ? new Date(endDate) : null;
              if (end) end.setHours(23, 59, 59, 999);
              return (
                (!start || qDate >= start) &&
                (!end || qDate <= end) &&
                (docType === "all" || q.type === docType)
              );
            });
            const resultsContainer =
              document.getElementById("doc-report-results");
            if (filteredQuotes.length === 0) {
              resultsContainer.innerHTML =
                '<p class="text-center py-4 text-slate-400">Nenhum documento encontrado para os filtros selecionados.</p>';
              return;
            }
            resultsContainer.innerHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50"><tr><th class="px-6 py-3">#</th><th class="px-6 py-3">Tipo</th><th class="px-6 py-3">Cliente</th><th class="px-6 py-3">Data</th><th class="px-6 py-3 text-right">Valor</th></tr></thead>
                    <tbody>${filteredQuotes
                      .map((quote) => {
                        const client = state.clients.find(
                          (c) => c.id === quote.clientId
                        ) || { name: "N/A" };
                        return `<tr class="border-b border-slate-700"> <td class="px-6 py-4">#${quote.docNumber
                          .toString()
                          .padStart(4, "0")}</td> <td class="px-6 py-4">${
                          quote.type === "quote" ? "Orçamento" : "Recibo"
                        }</td> <td class="px-6 py-4">${
                          client.name
                        }</td> <td class="px-6 py-4">${formatDate(
                          quote.date
                        )}</td> <td class="px-6 py-4 text-right">${formatCurrency(
                          quote.total
                        )}</td> </tr>`;
                      })
                      .join("")}</tbody>
                </table>`;
          });
      };

      const renderClientSalesReport = (container) => {
        const clientSales = {};
        state.clients.forEach((client) => {
          clientSales[client.id] = { name: client.name, total: 0 };
        });
        state.quotes.forEach((quote) => {
          if (quote.type === "receipt" && clientSales[quote.clientId])
            clientSales[quote.clientId].total += quote.total;
        });
        const sortedClients = Object.values(clientSales).sort(
          (a, b) => b.total - a.total
        );
        container.innerHTML = `
            <h3 class="text-xl font-bold mb-4 text-white">Vendas por Cliente</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                     <thead class="text-xs text-slate-400 uppercase bg-slate-700/50"><tr><th class="px-6 py-3">Posição</th><th class="px-6 py-3">Cliente</th><th class="px-6 py-3 text-right">Total Faturado</th></tr></thead>
                    <tbody>${sortedClients
                      .map(
                        (client, index) =>
                          `<tr class="border-b border-slate-700"> <td class="px-6 py-4">${
                            index + 1
                          }</td> <td class="px-6 py-4 font-medium">${
                            client.name
                          }</td> <td class="px-6 py-4 text-right font-semibold">${formatCurrency(
                            client.total
                          )}</td> </tr>`
                      )
                      .join("")}</tbody>
                </table>
            </div>`;
      };

      const renderProductSalesReport = (container) => {
        const productSales = {};
        state.products.forEach((product) => {
          productSales[product.id] = {
            name: product.name,
            quantity: 0,
            total: 0,
          };
        });
        state.quotes.forEach((quote) => {
          if (quote.type === "receipt") {
            quote.items.forEach((item) => {
              if (productSales[item.productId]) {
                productSales[item.productId].quantity += item.quantity;
                productSales[item.productId].total +=
                  item.quantity * item.price;
              }
            });
          }
        });
        const sortedProducts = Object.values(productSales).sort(
          (a, b) => b.total - a.total
        );
        container.innerHTML = `
            <h3 class="text-xl font-bold mb-4 text-white">Vendas por Produto/Serviço</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                     <thead class="text-xs text-slate-400 uppercase bg-slate-700/50"><tr><th class="px-6 py-3">Produto/Serviço</th><th class="px-6 py-3 text-center">Qtd. Vendida</th><th class="px-6 py-3 text-right">Total Faturado</th></tr></thead>
                    <tbody>${sortedProducts
                      .map(
                        (product) =>
                          `<tr class="border-b border-slate-700"> <td class="px-6 py-4 font-medium">${
                            product.name
                          }</td> <td class="px-6 py-4 text-center">${
                            product.quantity
                          }</td> <td class="px-6 py-4 text-right font-semibold">${formatCurrency(
                            product.total
                          )}</td> </tr>`
                      )
                      .join("")}</tbody>
                </table>
            </div>`;
      };

      // =================================================================================
      // MODAIS DE CADASTRO/EDIÇÃO
      // =================================================================================

      const renderProductModal = (productId = null, onSaveSuccess = null) => {
        const isEditing = productId !== null;
        const product = isEditing
          ? state.products.find((p) => p.id === productId)
          : { name: "", description: "", price: "" };
        const modalContainer = document.getElementById("modal-container");
        modalContainer.innerHTML = `
            <div id="product-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in print-hide">
                <form id="product-form" class="bg-slate-800 rounded-xl shadow-2xl max-w-lg w-full p-6 animate-scale-up space-y-4">
                    <h3 class="text-lg font-bold text-white">${
                      isEditing ? "Editar Item" : "Novo Item"
                    }</h3>
                    <div> <label for="product-name" class="block text-sm font-medium mb-1 text-slate-300">Nome</label> <input type="text" id="product-name" value="${
                      product.name
                    }" required class="w-full bg-slate-700 rounded-lg p-2 text-white"> </div>
                    <div> <label for="product-description" class="block text-sm font-medium mb-1 text-slate-300">Descrição</label> <textarea id="product-description" rows="3" class="w-full bg-slate-700 rounded-lg p-2 text-white">${
                      product.description || ""
                    }</textarea> </div>
                    <div> <label for="product-price" class="block text-sm font-medium mb-1 text-slate-300">Preço (R$)</label> <input type="number" id="product-price" value="${
                      product.price
                    }" step="0.01" min="0" required class="w-full bg-slate-700 rounded-lg p-2 text-white"> </div>
                    <div class="flex justify-end gap-3 pt-4"> <button type="button" data-modal-cancel class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500">Cancelar</button> <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Salvar</button> </div>
                </form>
            </div>`;
        const form = modalContainer.querySelector("#product-form");
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const newProductData = {
            id: isEditing ? productId : generateUniqueId(),
            name: form.querySelector("#product-name").value,
            description: form.querySelector("#product-description").value,
            price: parseFloat(form.querySelector("#product-price").value),
          };
          if (isEditing) {
            const index = state.products.findIndex((p) => p.id === productId);
            state.products[index] = newProductData;
          } else {
            state.products.push(newProductData);
          }
          saveState();
          if (typeof onSaveSuccess === "function")
            onSaveSuccess(newProductData);
          else renderProductsList();
          showToast(
            `Item ${isEditing ? "atualizado" : "adicionado"}.`,
            "success"
          );
          modalContainer.innerHTML = "";
        });
        modalContainer
          .querySelector("[data-modal-cancel]")
          .addEventListener("click", () => (modalContainer.innerHTML = ""));
      };

      const renderClientModal = (clientId = null, onSaveSuccess = null) => {
        const isEditing = clientId !== null;
        const client = isEditing
          ? state.clients.find((c) => c.id === clientId)
          : {
              name: "",
              docType: "cpf",
              docNumber: "",
              email: "",
              phone: "",
              cep: "",
              street: "",
              number: "",
              neighborhood: "",
              city: "",
              state: "",
              notes: "",
            };
        const modalContainer = document.getElementById("modal-container");
        modalContainer.innerHTML = `
            <div id="client-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in print-hide">
                <form id="client-form" class="bg-slate-800 rounded-xl shadow-2xl max-w-2xl w-full p-6 animate-scale-up space-y-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-lg font-bold text-white">${
                      isEditing ? "Editar Cliente" : "Novo Cliente"
                    }</h3>
                    <div> <label for="client-name" class="block text-sm font-medium mb-1 text-slate-300">Nome / Razão Social <span class="text-red-500">*</span></label> <input type="text" id="client-name" value="${
                      client.name
                    }" required class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                    <div class="flex items-end gap-2">
                         <div class="flex-shrink-0 w-28"> <label for="client-docType" class="block text-sm font-medium mb-1 text-slate-300">Tipo</label> <select id="client-docType" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> <option value="cpf" ${
                           client.docType === "cpf" ? "selected" : ""
                         }>CPF</option> <option value="cnpj" ${
          client.docType === "cnpj" ? "selected" : ""
        }>CNPJ</option> </select> </div>
                         <div class="flex-grow"> <label for="client-docNumber" class="block text-sm font-medium mb-1 text-slate-300">Documento</label> <input type="text" id="client-docNumber" value="${
                           client.docNumber || ""
                         }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div> <label for="client-email" class="block text-sm font-medium mb-1 text-slate-300">Email</label> <input type="email" id="client-email" value="${
                          client.email || ""
                        }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                        <div> <label for="client-phone" class="block text-sm font-medium mb-1 text-slate-300">Telefone</label> <input type="tel" id="client-phone" value="${
                          client.phone || ""
                        }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                    </div>
                    <div class="pt-4 border-t border-slate-700">
                         <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="sm:col-span-1"> <label for="client-cep" class="block text-sm font-medium mb-1 text-slate-300">CEP</label> <input type="text" id="client-cep" value="${
                              client.cep || ""
                            }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                         </div>
                         <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
                            <div class="sm:col-span-2"> <label for="client-street" class="block text-sm font-medium mb-1 text-slate-300">Rua</label> <input type="text" id="client-street" value="${
                              client.street || ""
                            }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                            <div> <label for="client-number" class="block text-sm font-medium mb-1 text-slate-300">Número</label> <input type="text" id="client-number" value="${
                              client.number || ""
                            }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                         </div>
                         <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
                            <div> <label for="client-neighborhood" class="block text-sm font-medium mb-1 text-slate-300">Bairro</label> <input type="text" id="client-neighborhood" value="${
                              client.neighborhood || ""
                            }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                            <div> <label for="client-city" class="block text-sm font-medium mb-1 text-slate-300">Cidade</label> <input type="text" id="client-city" value="${
                              client.city || ""
                            }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                            <div> <label for="client-state" class="block text-sm font-medium mb-1 text-slate-300">Estado (UF)</label> <input type="text" id="client-state" value="${
                              client.state || ""
                            }" class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                         </div>
                    </div>
                     <div class="pt-4 border-t border-slate-700">
                        <label for="client-notes" class="block text-sm font-medium mb-1 text-slate-300">Observações</label>
                        <textarea id="client-notes" rows="3" class="w-full bg-slate-700 rounded-lg p-2.5 text-white">${
                          client.notes || ""
                        }</textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-4"> <button type="button" data-modal-cancel class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500">Cancelar</button> <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Salvar</button> </div>
                </form>
            </div>
        `;
        const form = modalContainer.querySelector("#client-form");
        const docTypeSelect = form.querySelector("#client-docType");
        const docNumberInput = form.querySelector("#client-docNumber");
        const phoneInput = form.querySelector("#client-phone");
        const cepInput = form.querySelector("#client-cep");
        const updateClientDocInputMask = () => {
          const type = docTypeSelect.value;
          docNumberInput.value = "";
          if (type === "cpf") {
            docNumberInput.placeholder = "000.000.000-00";
            docNumberInput.maxLength = 14;
          } else {
            docNumberInput.placeholder = "00.000.000/0001-00";
            docNumberInput.maxLength = 18;
          }
        };
        docTypeSelect.addEventListener("change", updateClientDocInputMask);
        docNumberInput.addEventListener("input", (e) => {
          e.target.value = maskDocument(e.target.value, docTypeSelect.value);
        });
        phoneInput.addEventListener("input", (e) => {
          e.target.value = maskPhone(e.target.value);
        });
        cepInput.addEventListener("input", (e) => {
          e.target.value = maskCep(e.target.value);
        });
        cepInput.addEventListener("blur", (e) =>
          fetchAddressByCep(e.target.value, form)
        );
        updateClientDocInputMask();
        if (isEditing) {
          docNumberInput.value = maskDocument(client.docNumber, client.docType);
          phoneInput.value = maskPhone(client.phone);
          cepInput.value = maskCep(client.cep);
        }
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const newClientData = {
            id: isEditing ? clientId : generateUniqueId(),
            name: form.querySelector("#client-name").value,
            docType: form.querySelector("#client-docType").value,
            docNumber: form.querySelector("#client-docNumber").value,
            email: form.querySelector("#client-email").value,
            phone: form.querySelector("#client-phone").value,
            cep: form.querySelector("#client-cep").value,
            street: form.querySelector("#client-street").value,
            number: form.querySelector("#client-number").value,
            neighborhood: form.querySelector("#client-neighborhood").value,
            city: form.querySelector("#client-city").value,
            state: form.querySelector("#client-state").value,
            notes: form.querySelector("#client-notes").value,
          };
          if (isEditing) {
            const index = state.clients.findIndex((c) => c.id === clientId);
            state.clients[index] = newClientData;
          } else {
            state.clients.push(newClientData);
          }
          saveState();
          if (typeof onSaveSuccess === "function") onSaveSuccess(newClientData);
          else renderClientsList();
          showToast(
            `Cliente ${isEditing ? "atualizado" : "adicionado"}.`,
            "success"
          );
          modalContainer.innerHTML = "";
        });
        modalContainer
          .querySelector("[data-modal-cancel]")
          .addEventListener("click", () => (modalContainer.innerHTML = ""));
      };

      const renderTaskModal = (taskId = null) => {
        const isEditing = taskId !== null;
        const task = isEditing
          ? state.tasks.find((t) => t.id === taskId)
          : {
              description: "",
              status: "Pendente",
              dueDate: new Date().toISOString().split("T")[0],
              clientId: null,
            };
        const modalContainer = document.getElementById("modal-container");
        let selectedClientId = task.clientId;
        modalContainer.innerHTML = `
            <div id="task-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in print-hide">
                 <form id="task-form" class="bg-slate-800 rounded-xl shadow-2xl max-w-lg w-full p-6 animate-scale-up space-y-4" autocomplete="off">
                    <h3 class="text-lg font-bold text-white">${
                      isEditing ? "Editar Tarefa" : "Nova Tarefa"
                    }</h3>
                    <div> <label for="task-description" class="block text-sm font-medium mb-1 text-slate-300">Descrição</label> <textarea id="task-description" rows="3" required class="w-full bg-slate-700 rounded-lg p-2 text-white">${
                      task.description
                    }</textarea> </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-slate-300">Vincular a Cliente?</label>
                        <div class="flex gap-4">
                            <label class="flex items-center"> <input type="radio" name="linkClient" value="no" class="form-radio" ${
                              !task.clientId ? "checked" : ""
                            }> <span class="ml-2">Não</span> </label>
                            <label class="flex items-center"> <input type="radio" name="linkClient" value="yes" class="form-radio" ${
                              task.clientId ? "checked" : ""
                            }> <span class="ml-2">Sim</span> </label>
                        </div>
                    </div>
                    <div id="client-link-container" class="${
                      task.clientId ? "" : "hidden"
                    }">
                         <label for="task-client-search" class="block text-sm font-medium mb-1 text-slate-300">Selecione o Cliente</label>
                         <div class="relative">
                             <input type="text" id="task-client-search" placeholder="Digite para buscar..." class="w-full bg-slate-700 rounded-lg p-2.5 text-white">
                             <div id="task-client-suggestions" class="absolute z-20 w-full bg-slate-600 border border-slate-500 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto"></div>
                         </div>
                         <div id="task-client-selected" class="mt-2 text-sm text-indigo-400 font-semibold"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div> <label for="task-status" class="block text-sm font-medium mb-1 text-slate-300">Status</label> <select id="task-status" required class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> <option value="Pendente" ${
                          task.status === "Pendente" ? "selected" : ""
                        }>Pendente</option> <option value="Em Andamento" ${
          task.status === "Em Andamento" ? "selected" : ""
        }>Em Andamento</option> <option value="Concluída" ${
          task.status === "Concluída" ? "selected" : ""
        }>Concluída</option> </select> </div>
                        <div> <label for="task-duedate" class="block text-sm font-medium mb-1 text-slate-300">Prazo</label> <input type="date" id="task-duedate" value="${
                          task.dueDate
                        }" required class="w-full bg-slate-700 rounded-lg p-2.5 text-white"> </div>
                    </div>
                    <div class="flex justify-end gap-3 pt-4"> <button type="button" data-modal-cancel class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500">Cancelar</button> <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Salvar</button> </div>
                </form>
            </div>
        `;
        const form = modalContainer.querySelector("#task-form");
        const clientLinkContainer = form.querySelector(
          "#client-link-container"
        );
        const clientSearchInput = form.querySelector("#task-client-search");
        const clientSuggestions = form.querySelector(
          "#task-client-suggestions"
        );
        const clientSelectedDiv = form.querySelector("#task-client-selected");

        form.querySelectorAll('input[name="linkClient"]').forEach((radio) => {
          radio.addEventListener("change", (e) => {
            const show = e.target.value === "yes";
            clientLinkContainer.classList.toggle("hidden", !show);
            if (!show) {
              selectedClientId = null;
              clientSelectedDiv.textContent = "";
              clientSearchInput.value = "";
            }
          });
        });

        const selectClientForTask = (client) => {
          selectedClientId = client.id;
          clientSearchInput.value = client.name;
          clientSelectedDiv.textContent = `Cliente: ${client.name}`;
          clientSuggestions.classList.add("hidden");
        };

        if (task.clientId) {
          const client = state.clients.find((c) => c.id === task.clientId);
          if (client) selectClientForTask(client);
        }

        clientSearchInput.addEventListener("input", () => {
          const searchTerm = clientSearchInput.value.toLowerCase();
          clientSuggestions.innerHTML = "";
          if (searchTerm.length === 0) {
            clientSuggestions.classList.add("hidden");
            return;
          }
          const filteredClients = state.clients.filter((client) =>
            client.name.toLowerCase().includes(searchTerm)
          );
          filteredClients.forEach((client) => {
            const item = document.createElement("div");
            item.className =
              "px-4 py-2 hover:bg-indigo-500 cursor-pointer text-white";
            item.textContent = client.name;
            item.dataset.clientId = client.id;
            clientSuggestions.appendChild(item);
          });
          clientSuggestions.classList.remove("hidden");
        });

        clientSuggestions.addEventListener("click", (e) => {
          if (e.target.dataset.clientId) {
            const client = state.clients.find(
              (c) => c.id === e.target.dataset.clientId
            );
            if (client) selectClientForTask(client);
          }
        });

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const linkClient =
            form.querySelector('input[name="linkClient"]:checked').value ===
            "yes";
          const updatedTask = {
            id: isEditing ? taskId : generateUniqueId(),
            description: form.querySelector("#task-description").value,
            status: form.querySelector("#task-status").value,
            dueDate: form.querySelector("#task-duedate").value,
            clientId: linkClient ? selectedClientId : null,
          };
          if (linkClient && !updatedTask.clientId) {
            showToast(
              "Por favor, selecione um cliente para vincular.",
              "error"
            );
            return;
          }
          if (isEditing) {
            const index = state.tasks.findIndex((t) => t.id === taskId);
            state.tasks[index] = updatedTask;
          } else {
            state.tasks.push(updatedTask);
          }
          saveState();
          renderTasksList();
          showToast(
            `Tarefa ${isEditing ? "atualizada" : "criada"}.`,
            "success"
          );
          modalContainer.innerHTML = "";
        });
        modalContainer
          .querySelector("[data-modal-cancel]")
          .addEventListener("click", () => (modalContainer.innerHTML = ""));
      };

      // =================================================================================
      // GERAÇÃO DE PDF E COMPARTILHAMENTO
      // =================================================================================

      const generateQuotePDF = ({ quote, client, action = "download" }) => {
        if (!quote || !client) {
          showToast("Dados incompletos para gerar PDF.", "error");
          return;
        }
        let doc = new jsPDF();
        // ... (buildPdfDocument logic remains the same)
        const filename = `${
          quote.type === "receipt" ? "Recibo" : "Orcamento"
        }_${client.name.replace(/\s/g, "_")}_${quote.docNumber}.pdf`;

        // Setting font for the entire document for consistency
        doc.setFont("Inter", "normal");

        // Header
        doc.setFontSize(16);
        doc.setTextColor(30, 41, 59); // slate-800
        doc.text(state.provider.name, 105, 20, { align: "center" });

        doc.setFontSize(10);
        doc.setTextColor(71, 85, 105); // slate-500
        const providerAddress = `${state.provider.street}, ${state.provider.number}, ${state.provider.neighborhood}, ${state.provider.city} - ${state.provider.state}, CEP ${state.provider.cep}`;
        doc.text(providerAddress, 105, 26, { align: "center" });
        doc.text(
          `Email: ${state.provider.email} | Telefone: ${state.provider.phone}`,
          105,
          32,
          { align: "center" }
        );

        // Document Type and Number
        doc.setFontSize(18);
        doc.setTextColor(24, 66, 215); // indigo-600
        const docTypeName = quote.type === "receipt" ? "RECIBO" : "ORÇAMENTO";
        doc.text(`${docTypeName} #${quote.docNumber}`, 105, 48, {
          align: "center",
        });

        // Client and Quote Details
        doc.setFontSize(10);
        doc.setTextColor(30, 41, 59); // slate-800

        let y = 60;
        doc.text("DADOS DO CLIENTE:", 14, y);
        doc.setFontSize(9);
        doc.setTextColor(71, 85, 105); // slate-500
        y += 6;
        doc.text(`Nome: ${client.name}`, 14, y);
        y += 5;
        doc.text(
          `Documento: ${client.docType.toUpperCase()}: ${client.docNumber}`,
          14,
          y
        );
        y += 5;
        doc.text(`Email: ${client.email || "N/A"}`, 14, y);
        y += 5;
        doc.text(`Telefone: ${client.phone || "N/A"}`, 14, y);
        y += 5;
        doc.text(
          `Endereço: ${client.street}, ${client.number}, ${client.neighborhood}, ${client.city} - ${client.state}`,
          14,
          y
        );

        y = 60; // Reset y for quote details column
        doc.setFontSize(10);
        doc.setTextColor(30, 41, 59); // slate-800
        doc.text("DADOS DO DOCUMENTO:", 110, y);
        doc.setFontSize(9);
        doc.setTextColor(71, 85, 105); // slate-500
        y += 6;
        doc.text(`Data de Emissão: ${formatDate(quote.date)}`, 110, y);
        if (quote.type === "quote") {
          y += 5;
          doc.text(
            `Validade da Proposta: ${formatDate(quote.dueDate)}`,
            110,
            y
          );
        } else {
          // Recibo
          y += 5;
          doc.text(
            `Data de Pagamento: ${formatDate(quote.receiptDate || quote.date)}`,
            110,
            y
          );
        }

        // Items Table
        y = Math.max(y + 10, 100); // Ensure table starts below previous content, at least at 100
        const tableColumn = ["Item", "Qtd", "Preço Unit.", "Subtotal"];
        const tableRows = [];
        quote.items.forEach((item) => {
          tableRows.push([
            item.name,
            item.quantity,
            formatCurrency(item.price),
            formatCurrency(item.quantity * item.price),
          ]);
        });

        doc.autoTable({
          startY: y,
          head: [tableColumn],
          body: tableRows,
          theme: "striped",
          headStyles: {
            fillColor: [51, 65, 85],
            textColor: [255, 255, 255],
            fontStyle: "bold",
          }, // slate-700
          styles: {
            font: "Inter",
            fontSize: 9,
            textColor: [30, 41, 59], // slate-800
          },
          columnStyles: {
            0: { cellWidth: "auto" },
            1: { cellWidth: 20, halign: "center" },
            2: { cellWidth: 30, halign: "right" },
            3: { cellWidth: 30, halign: "right" },
          },
          margin: { top: 10, left: 14, right: 14 },
          didDrawPage: function (data) {
            // Footer for each page
            let pageNumber = doc.internal.getNumberOfPages();
            doc.setFontSize(8);
            doc.setTextColor(100);
            doc.text(
              `Página ${pageNumber}`,
              data.settings.margin.left,
              doc.internal.pageSize.height - 10
            );
          },
        });

        // Get the final Y position after the table
        y = doc.autoTable.previous.finalY;

        // Total
        doc.setFontSize(12);
        doc.setTextColor(30, 41, 59);
        doc.text(
          `TOTAL: ${formatCurrency(quote.total)}`,
          doc.internal.pageSize.width - 14,
          y + 10,
          { align: "right" }
        );

        // Notes
        if (quote.notes) {
          y += 20;
          doc.setFontSize(10);
          doc.setTextColor(30, 41, 59);
          doc.text("NOTAS:", 14, y);
          doc.setFontSize(9);
          doc.setTextColor(71, 85, 105);
          doc.text(quote.notes, 14, y + 5, { maxWidth: 180 });
        }

        if (action === "preview") doc.output("dataurlnewwindow");
        else doc.save(filename);
      };

      const shareQuote = async (quote, client) => {
        if (!quote || !client) {
          showToast("Dados incompletos.", "error");
          return;
        }
        const docType = quote.type === "receipt" ? "Recibo" : "Orçamento";
        let summaryText =
          `*${docType} #${quote.docNumber} - ${state.provider.name}*\n\n` +
          `*Cliente:* ${client.name}\n` +
          `*Data:* ${formatDate(quote.date)}\n\n*Itens:*\n` +
          quote.items
            .map(
              (item) =>
                `- ${item.name} (Qtd: ${item.quantity}): ${formatCurrency(
                  item.quantity * item.price
                )}`
            )
            .join("\n") +
          `\n\n*Total:* *${formatCurrency(quote.total)}*\n\n` +
          (quote.notes ? `*Notas:* ${quote.notes}` : "");
        await shareText(summaryText, `${docType} - ${client.name}`);
      };

      const shareText = async (text, title) => {
        const modalContainer = document.getElementById("modal-container");
        modalContainer.innerHTML = `
            <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
                <div class="bg-slate-800 rounded-xl shadow-2xl max-w-lg w-full p-6 animate-scale-up">
                    <h3 class="text-lg font-bold mb-4 text-white">Compartilhar ${title}</h3>
                    <p class="text-sm text-slate-400 mb-2">Copie o texto abaixo para compartilhar manualmente.</p>
                    <textarea readonly class="w-full h-48 bg-slate-700 text-sm p-2 border border-slate-600 rounded-md resize-none text-white">${text}</textarea>
                    <div class="flex justify-end gap-3 mt-4">
                        <button data-modal-cancel class="px-4 py-2 rounded-lg bg-slate-600">Fechar</button>
                        <button id="copy-text-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Copiar</button>
                    </div>
                </div>
            </div>
        `;
        const modal = modalContainer.firstElementChild;
        modal
          .querySelector("[data-modal-cancel]")
          .addEventListener("click", () => modal.remove());
        modal.querySelector("#copy-text-btn").addEventListener("click", () => {
          const textArea = modal.querySelector("textarea");
          textArea.select();
          document.execCommand("copy");
          showToast("Texto copiado!", "success");
        });
      };

      const generateReportPDF = (action = "download") => {
        const doc = new jsPDF();
        doc.setFont("Inter", "normal");
        let yPos = 20;

        const addSectionTitle = (title) => {
          doc.setFontSize(16);
          doc.setTextColor(30, 41, 59); // slate-800
          doc.text(title, 14, yPos);
          yPos += 10;
        };

        const addTable = (columns, data, title = "") => {
          if (title) {
            addSectionTitle(title);
            yPos += 5; // Extra space after section title
          }
          doc.autoTable({
            startY: yPos,
            head: [columns],
            body: data,
            theme: "striped",
            headStyles: {
              fillColor: [51, 65, 85],
              textColor: [255, 255, 255],
              fontStyle: "bold",
            },
            styles: { font: "Inter", fontSize: 9, textColor: [30, 41, 59] },
            margin: { top: 10, left: 14, right: 14 },
            didDrawPage: function (data) {
              let pageNumber = doc.internal.getNumberOfPages();
              doc.setFontSize(8);
              doc.setTextColor(100);
              doc.text(
                `Página ${pageNumber}`,
                data.settings.margin.left,
                doc.internal.pageSize.height - 10
              );
            },
          });
          yPos = doc.autoTable.previous.finalY + 15; // Update yPos for next content
        };

        // Financial Report
        addSectionTitle("Resumo Financeiro");
        const receipts = state.quotes.filter((q) => q.type === "receipt");
        const openQuotes = state.quotes.filter((q) => q.type === "quote");
        const totalRevenue = receipts.reduce((sum, q) => sum + q.total, 0);
        const totalOpen = openQuotes.reduce((sum, q) => sum + q.total, 0);
        const averageTicket =
          receipts.length > 0 ? totalRevenue / receipts.length : 0;

        doc.setFontSize(10);
        doc.setTextColor(71, 85, 105);
        doc.text(
          `Total Faturado (Recibos): ${formatCurrency(totalRevenue)}`,
          14,
          yPos
        );
        yPos += 7;
        doc.text(
          `Total em Aberto (Orçamentos): ${formatCurrency(totalOpen)}`,
          14,
          yPos
        );
        yPos += 7;
        doc.text(
          `Ticket Médio (Recibos): ${formatCurrency(averageTicket)}`,
          14,
          yPos
        );
        yPos += 15;

        // Documents Report (All documents)
        doc.addPage();
        yPos = 20; // Reset Y for new page
        addSectionTitle("Relatório Completo de Documentos");
        const allDocuments = [...state.quotes].sort(
          (a, b) => new Date(a.date) - new Date(b.date)
        );
        if (allDocuments.length > 0) {
          const docColumns = ["#", "Tipo", "Cliente", "Data", "Valor"];
          const docRows = allDocuments.map((q) => {
            const client = state.clients.find((c) => c.id === q.clientId) || {
              name: "N/A",
            };
            return [
              `#${q.docNumber.toString().padStart(4, "0")}`,
              q.type === "quote" ? "Orçamento" : "Recibo",
              client.name,
              formatDate(q.date),
              formatCurrency(q.total),
            ];
          });
          addTable(docColumns, docRows);
        } else {
          doc.setFontSize(10);
          doc.setTextColor(71, 85, 105);
          doc.text("Nenhum documento para este relatório.", 14, yPos);
          yPos += 15;
        }

        // Client Sales Report
        doc.addPage();
        yPos = 20; // Reset Y for new page
        addSectionTitle("Vendas por Cliente");
        const clientSales = {};
        state.clients.forEach((client) => {
          clientSales[client.id] = { name: client.name, total: 0 };
        });
        state.quotes.forEach((quote) => {
          if (quote.type === "receipt" && clientSales[quote.clientId])
            clientSales[quote.clientId].total += quote.total;
        });
        const sortedClients = Object.values(clientSales).sort(
          (a, b) => b.total - a.total
        );
        if (sortedClients.length > 0) {
          const clientSalesColumns = ["Posição", "Cliente", "Total Faturado"];
          const clientSalesRows = sortedClients.map((client, index) => [
            index + 1,
            client.name,
            formatCurrency(client.total),
          ]);
          addTable(clientSalesColumns, clientSalesRows);
        } else {
          doc.setFontSize(10);
          doc.setTextColor(71, 85, 105);
          doc.text("Nenhuma venda registrada para clientes.", 14, yPos);
          yPos += 15;
        }

        // Product Sales Report
        doc.addPage();
        yPos = 20; // Reset Y for new page
        addSectionTitle("Vendas por Produto/Serviço");
        const productSales = {};
        state.products.forEach((product) => {
          productSales[product.id] = {
            name: product.name,
            quantity: 0,
            total: 0,
          };
        });
        state.quotes.forEach((quote) => {
          if (quote.type === "receipt") {
            quote.items.forEach((item) => {
              if (productSales[item.productId]) {
                productSales[item.productId].quantity += item.quantity;
                productSales[item.productId].total +=
                  item.quantity * item.price;
              }
            });
          }
        });
        const sortedProducts = Object.values(productSales).sort(
          (a, b) => b.total - a.total
        );
        if (sortedProducts.length > 0) {
          const productSalesColumns = [
            "Produto/Serviço",
            "Qtd. Vendida",
            "Total Faturado",
          ];
          const productSalesRows = sortedProducts.map((product) => [
            product.name,
            product.quantity,
            formatCurrency(product.total),
          ]);
          addTable(productSalesColumns, productSalesRows);
        } else {
          doc.setFontSize(10);
          doc.setTextColor(71, 85, 105);
          doc.text(
            "Nenhuma venda registrada para produtos/serviços.",
            14,
            yPos
          );
          yPos += 15;
        }

        const filename = `Relatorio_OrçaFácil_${
          new Date().toISOString().split("T")[0]
        }.pdf`;

        if (action === "preview") doc.output("dataurlnewwindow");
        else if (action === "download") doc.save(filename);
        else if (action === "share") {
          doc.output("dataurlstring", {
            callback: function (dataUrl) {
              // This converts dataUrl to Blob, which is sometimes necessary for navigator.share
              fetch(dataUrl)
                .then((res) => res.blob())
                .then((blob) => {
                  const file = new File([blob], filename, {
                    type: "application/pdf",
                  });
                  if (
                    navigator.canShare &&
                    navigator.canShare({ files: [file] })
                  ) {
                    navigator
                      .share({
                        files: [file],
                        title: filename,
                        text: "Relatório OrçaFácil",
                      })
                      .catch((error) => {
                        console.error(
                          "Erro ao compartilhar o relatório:",
                          error
                        );
                        showToast(
                          "Não foi possível compartilhar o relatório. Tente baixar e enviar manualmente.",
                          "error"
                        );
                      });
                  } else {
                    showToast(
                      "Seu navegador não suporta compartilhamento de arquivos. O PDF foi baixado.",
                      "info"
                    );
                    doc.save(filename); // Fallback to download
                  }
                })
                .catch((error) => {
                  console.error(
                    "Erro ao processar PDF para compartilhamento:",
                    error
                  );
                  showToast(
                    "Erro ao preparar o relatório para compartilhamento.",
                    "error"
                  );
                });
            },
          });
        }
      };

      // =================================================================================
      // FUNÇÕES DE MÁSCARA E API
      // =================================================================================
      const maskDocument = (value, type) => {
        const onlyNumbers = (value || "").replace(/[^\d]/g, "");
        if (type === "cpf")
          return onlyNumbers
            .replace(/(\d{3})(\d)/, "$1.$2")
            .replace(/(\d{3})(\d)/, "$1.$2")
            .replace(/(\d{3})(\d{1,2})/, "$1-$2")
            .substr(0, 14);
        return onlyNumbers
          .replace(/(\d{2})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1/$2")
          .replace(/(\d{4})(\d)/, "$1-$2")
          .substr(0, 18);
      };

      const maskPhone = (value) => {
        const onlyNumbers = (value || "").replace(/[^\d]/g, "");
        if (onlyNumbers.length > 10)
          return onlyNumbers
            .replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3")
            .substr(0, 15);
        return onlyNumbers
          .replace(/(\d{2})(\d{4})(\d{4})/, "($1) $2-$3")
          .substr(0, 14);
      };

      const maskCep = (value) =>
        (value || "")
          .replace(/\D/g, "")
          .replace(/(\d{5})(\d)/, "$1-$2")
          .substr(0, 9);

      const fetchAddressByCep = async (cep, form, target = "client") => {
        const cleanCep = (cep || "").replace(/\D/g, "");
        if (cleanCep.length !== 8) return;
        try {
          const response = await fetch(
            `https://viacep.com.br/ws/${cleanCep}/json/`
          );
          if (!response.ok) throw new Error("Falha na requisição");
          const data = await response.json();
          if (data.erro) {
            showToast("CEP não encontrado.", "error");
            return;
          }

          if (target === "client") {
            form.querySelector("#client-street").value = data.logradouro || "";
            form.querySelector("#client-neighborhood").value =
              data.bairro || "";
            form.querySelector("#client-city").value = data.localidade || "";
            form.querySelector("#client-state").value = data.uf || "";
            form.querySelector("#client-number").focus();
          } else if (target === "provider") {
            form.querySelector("#provider-street").value =
              data.logradouro || "";
            form.querySelector("#provider-neighborhood").value =
              data.bairro || "";
            form.querySelector("#provider-city").value = data.localidade || "";
            form.querySelector("#provider-state").value = data.uf || "";
            form.querySelector("#provider-number").focus();
          }
        } catch (error) {
          showToast("Erro ao consultar o CEP.", "error");
        }
      };

      // =================================================================================
      // INICIALIZAÇÃO DA APLICAÇÃO
      // =================================================================================
      const init = () => {
        loadState();
        renderSidebar();
        initTheme(); // Inicializa o controle do tema

        document
          .getElementById("hamburger-btn")
          .addEventListener("click", () => toggleSidebar(true));
        document
          .getElementById("sidebar-overlay")
          .addEventListener("click", () => toggleSidebar(false));

        document.getElementById("sidebar").addEventListener("click", (e) => {
          const navLink = e.target.closest(".nav-link");
          if (navLink) {
            e.preventDefault();
            switchView(navLink.getAttribute("href").substring(1));
          }
        });

        window.addEventListener("hashchange", () => {
          const viewId = window.location.hash.substring(1) || "dashboard-view";
          switchView(viewId);
        });

        const initialView =
          window.location.hash.substring(1) || "dashboard-view";
        switchView(initialView);
      };

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>

